{% extends "layout.html" %}
{% block title %}To-Do App{% endblock %}

{% block content %}
  <div class="jumbotron">
    <h1 class="display-4">To-Do App</h1>
    <p class="lead">This is not just any to-do app...</p>
  </div>

  <div class="row">
    <div class="col-md-12">
      <h2>Items</h2>
      <div>
        <button type="button" class="btn btn-primary" onclick="createNewItem()">Create</button>
        <label for="title">New Todo:</label> <input required type="text" id="new_item_title" name="title" value="" />
      </div>

      <h3>To Do</h3>
      <ul id="todo_list" class="list-group">
        <!-- List the todo items here -->
        {% for item in view_model.to_do_items %}
        <li class="list-group-item" id="li{{ item.id}}" >
          <a  data-toggle="collapse" class="row list-group-item-action" href="#collapse{{ item.id }}" role="button" aria-expanded="false" aria-controls="collapse{{ item.id }}">
            {{ item.title }}
          </a>
          <div class="collapse row" id="collapse{{ item.id }}">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-secondary active">
                <input onchange="updateStatus('{{item.id}}', 'To Do')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionToDo" autocomplete="off" checked> Todo
              </label>
              <label class="btn btn-secondary">
                <input onchange="updateStatus('{{item.id}}', 'Doing')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionDoing" autocomplete="off"> Doing
              </label>
              <label class="btn btn-secondary">
                <input onchange="updateStatus('{{item.id}}', 'Done')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionDone" autocomplete="off"> Done
              </label>
              <button onclick="deleteItem('{{ item.id }}')" class="btn btn-outline-danger">Delete Item</button>
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>


      <h3>Doing</h3>
      <ul id="doing_list" class="list-group">
        <!-- List the todo items here -->
        {% for item in view_model.doing_items %}
        <li class="list-group-item" id="li{{ item.id}}" >
          <a  data-toggle="collapse" class="row list-group-item-action" href="#collapse{{ item.id }}" role="button" aria-expanded="false" aria-controls="collapse{{ item.id }}">
            {{ item.title }}
          </a>
          <div class="collapse row" id="collapse{{ item.id }}">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-secondary">
                <input onchange="updateStatus('{{item.id}}', 'To Do')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionToDo" autocomplete="off" > Todo
              </label>
              <label class="btn btn-secondary active">
                <input onchange="updateStatus('{{item.id}}', 'Doing')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionDoing" autocomplete="off" checked> Doing
              </label>
              <label class="btn btn-secondary">
                <input onchange="updateStatus('{{item.id}}', 'Done')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionDone" autocomplete="off"> Done
              </label>
              <button onclick="deleteItem('{{ item.id }}')" class="btn btn-outline-danger">Delete Item</button>
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>

      <h3>Done</h3>
      <ul id="done_list" class="list-group">
        <!-- List the todo items here -->
        {% for item in view_model.done_items %}
        <li class="list-group-item" id="li{{ item.id}}" >
          <a  data-toggle="collapse" class="row list-group-item-action" href="#collapse{{ item.id }}" role="button" aria-expanded="false" aria-controls="collapse{{ item.id }}">
            {{ item.title }}
          </a>
          <div class="collapse row" id="collapse{{ item.id }}">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-secondary">
                <input onchange="updateStatus('{{item.id}}', 'To Do')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionToDo" autocomplete="off" > Todo
              </label>
              <label class="btn btn-secondary">
                <input onchange="updateStatus('{{item.id}}', 'Doing')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionDoing" autocomplete="off" > Doing
              </label>
              <label class="btn btn-secondary active">
                <input onchange="updateStatus('{{item.id}}', 'Done')" type="radio" name="{{ item.id }}ListOption" id="{{ item.id }}ListOptionDone" autocomplete="off" checked> Done
              </label>
              <button onclick="deleteItem('{{ item.id }}')" class="btn btn-outline-danger">Delete Item</button>
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>

    </div>

  </div>

  <script>

    function newTodoNode(item) {
        const newNode = document.createElement("li")
        newNode.classList.add("list-group-item")
        newNode.id = "li" + item.id

        title = document.createElement("a")
        title.classList.add("row", "list-group-item-action")
        title.dataset.toggle = 'collapse'
        title.setAttribute('href', "#collapse"+item.id);
        title.setAttribute('role', 'button');
        title.setAttribute('aria-expanded', 'false');
        title.setAttribute('aria-controls', "collapse"+item.id);
        title.innerHTML = item.title;
        newNode.appendChild(title);


        menu_options = document.createElement("div")
        menu_options.classList.add("collapse", "row")
        menu_options.id = "collapse"+item.id
        menu_options.innerHTML = 'wibble';
        newNode.appendChild(menu_options);


        // const button = document.createElement("button");
        // button.onclick = function() {deleteItem(todo.id)};
        // button.type = "button"
        // button.classList.add("btn","btn-outline-danger","btn-sm")
        // button.innerText = 'X'

        // const date = document.createElement("input");
        // date.id = 'date' + todo.id
        // date.type = "text"
        // date.classList.add("date","form-control")

        // const dateWrapper = document.createElement("div")
        // dateWrapper.classList.add("col-auto")
        // dateWrapper.appendChild(date)


        // const status = document.createElement("div");
        // status.id = 'status' + todo.id
        // status.onclick = function(e) {updateStatus(todo.id, e)};
        // status.classList.add("col-auto")
        // status.innerText = todo.status

        // const title = document.createElement("div");
        // title.classList.add("col-auto")
        // title.innerText = todo.title

        // newNode.appendChild(buttonWrapper)
        // newNode.appendChild(dateWrapper)
        // newNode.appendChild(status)
        // newNode.appendChild(title)

        return newNode
    }

  
    function createNewItem() {
    //  event.preventDefault()
      name  = document.getElementById("new_item_title").value;

      formData = new FormData();
      formData.append('title', name)

      fetch('/todo/add', {
        method: 'POST',
        body: formData,
      }).then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then((item) => {
        const todoList = document.getElementById('todo_list')
        newNode = newTodoNode(item);
        
        todoList.appendChild(newNode)
      })
    }

    function updateStatus(itemId, newStatus) {
      fetch("/todo/"+ itemId +"/status", {
        method: "PUT",
        body: newStatus,
      }).then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then((item) => {
        var listItem = document.getElementById("li"+itemId);
        switch(newStatus) {
          case 'To Do': document.getElementById("todo_list").appendChild(listItem); 
                        break;
          case 'Doing': document.getElementById("doing_list").appendChild(listItem); 
                        break;
          case 'Done': document.getElementById("done_list").appendChild(listItem); 
                        break;
        }
        $('#collapse'+itemId).collapse('hide')
  
      }).catch(error => {
        alert("Whoops! " + error)
      })
    }

    function deleteItem(itemId) {
      fetch("/todo/" + itemId, {
        method: "delete",
      }).then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const li = document.getElementById("li" + itemId)
        li.remove()
      }).catch(error => {
        alert("Whoops! " + error)
      })
    }
  </script>
{% endblock %}